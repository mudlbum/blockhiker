<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Voxel Quest: Final Fix</title>
    <style>
        body { margin: 0; overflow: hidden; background: #222; font-family: sans-serif; user-select: none; touch-action: none; -webkit-user-select: none; }
        canvas { display: block; }
        
        /* UI Ïä§ÌÉÄÏùº */
        .pixel-font { font-family: monospace; font-weight: bold; text-shadow: 1px 1px 0 #000; color: white; }
        #ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; }
        
        /* HUD */
        #hud-top { position: absolute; top: 10px; left: 10px; display: flex; flex-direction: column; gap: 5px; }
        .bar-con { width: 120px; height: 12px; background: #333; border: 2px solid #fff; position: relative; }
        .bar-fill { height: 100%; width: 100%; transition: width 0.2s; }
        .gold-txt { color: #FFD700; font-size: 16px; margin-left: 5px; }

        /* Ïù∏Î≤§ÌÜ†Î¶¨ */
        #inv-wrap { position: absolute; top: 10px; right: 10px; width: 160px; height: 50px; overflow-x: auto; pointer-events: auto; white-space: nowrap; -webkit-overflow-scrolling: touch; }
        #inv-wrap::-webkit-scrollbar { display: none; }
        .slot { display: inline-flex; width: 40px; height: 40px; border: 2px solid #555; background: rgba(0,0,0,0.5); margin-right: 4px; justify-content: center; align-items: center; border-radius: 6px; position: relative; }
        .slot.active { border-color: #FFD700; background: rgba(255,215,0,0.3); }
        .icon { font-size: 20px; }
        .b-preview { width: 20px; height: 20px; }

        /* Ïª®Ìä∏Î°§Îü¨ */
        #controls { position: absolute; bottom: 20px; width: 100%; height: 140px; pointer-events: none; display: flex; justify-content: space-between; padding: 0 20px; box-sizing: border-box; }
        .c-btn { width: 70px; height: 70px; background: rgba(255,255,255,0.2); border: 2px solid rgba(255,255,255,0.4); border-radius: 50%; pointer-events: auto; display: flex; justify-content: center; align-items: center; font-size: 24px; color: white; backdrop-filter: blur(4px); }
        .c-btn:active { background: rgba(255,215,0,0.4); border-color: #FFD700; }
        .c-col { display: flex; flex-direction: column; gap: 10px; justify-content: flex-end; }
        #btn-mode { width: 50px; height: 50px; border-radius: 12px; font-size: 20px; background: rgba(0,0,0,0.6); margin-bottom: 10px; align-self: flex-end; }
        
        /* Ïò§Î≤ÑÎ†àÏù¥ (Î©îÎâ¥) */
        #overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.9); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 100; pointer-events: auto; }
        .panel { background: #333; padding: 20px; border-radius: 10px; border: 2px solid #4CAF50; text-align: center; width: 80%; max-width: 300px; }
        .big-btn { background: #4CAF50; color: white; border: none; padding: 12px; width: 100%; font-size: 16px; font-weight: bold; margin-top: 10px; border-radius: 5px; }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 5px; margin-top: 10px; }
        .shop-item { background: #555; padding: 8px; font-size: 12px; border-radius: 4px; border: 1px solid #777; color: white; }
        
        /* ÏïåÎ¶º */
        .toast { position: absolute; top: 20%; left: 50%; transform: translate(-50%, -50%); color: #FFD700; font-size: 20px; font-weight: bold; text-shadow: 2px 2px 0 #000; opacity: 0; transition: opacity 0.5s; pointer-events: none; }
        #boss-hud { position: absolute; top: 60px; left: 50%; transform: translateX(-50%); width: 200px; display: none; text-align: center; }
        .boss-bar { width: 100%; height: 8px; background: #333; border: 1px solid #fff; }
        .boss-fill { height: 100%; background: #FF4081; width: 100%; }
    </style>
</head>
<body>

<canvas id="cvs"></canvas>

<div id="ui-layer">
    <div id="hud-top" class="pixel-font">
        <div>LV <span id="ui-lv">1</span> <span class="gold-txt">$<span id="ui-gold">0</span></span></div>
        <div class="bar-con"><div id="hp-bar" class="bar-fill" style="background:#f44336;"></div></div>
        <div class="bar-con" id="air-con" style="display:none; border-color:#03A9F4; height:6px; margin-top:2px;"><div id="air-bar" class="bar-fill" style="background:#03A9F4;"></div></div>
    </div>
    
    <div id="boss-hud" class="pixel-font">
        <div style="color:#FF4081; font-size:12px;">BOSS</div>
        <div class="boss-bar"><div id="boss-fill" class="boss-fill"></div></div>
    </div>

    <div id="toast" class="toast">Ï†ÄÏû•Îê®!</div>
</div>

<div id="inv-wrap"></div>

<div id="controls">
    <div class="c-col" style="flex-direction:row; gap:15px;">
        <div id="btn-l" class="c-btn">‚óÄ</div>
        <div id="btn-r" class="c-btn">‚ñ∂</div>
    </div>
    <div class="c-col">
        <div id="btn-mode" class="c-btn" style="border-radius:10px;">‚õèÔ∏è</div>
        <div id="btn-j" class="c-btn">‚¨Ü</div>
    </div>
</div>

<div id="overlay">
    <div id="p-main" class="panel">
        <h1 style="color:#FFD700; margin:0 0 10px 0;">VOXEL QUEST</h1>
        <p style="color:#aaa; font-size:12px;">Î™®Î∞îÏùº ÏàòÏ†ï Î≤ÑÏ†Ñ</p>
        <button class="big-btn" onclick="Game.start(true)">ÏÉà Í≤åÏûÑ ÏãúÏûë</button>
        <button id="btn-load" class="big-btn" style="background:#2196F3; display:none;" onclick="Game.load()">Ïù¥Ïñ¥ÌïòÍ∏∞</button>
    </div>
    
    <div id="p-shop" class="panel" style="display:none;">
        <h2 style="color:#fff; margin:0;">ÌÅ¥Î¶¨Ïñ¥!</h2>
        <div class="shop-grid">
            <div class="shop-item" onclick="Game.buy('heal')">‚ù§Ô∏è ÌöåÎ≥µ (50G)</div>
            <div class="shop-item" onclick="Game.buy('dmg')">‚öîÔ∏è Í≥µÍ≤© (200G)</div>
            <div class="shop-item" onclick="Game.buy('spd')">üëü ÏÜçÎèÑ (150G)</div>
            <div class="shop-item" onclick="Game.buy('hp')">üõ°Ô∏è Ï≤¥Î†• (300G)</div>
            <div class="shop-item" onclick="Game.buy('wand')">üî• ÎßàÎ≤ï (500G)</div>
        </div>
        <button class="big-btn" onclick="Game.nextLevel()">Îã§Ïùå Î†àÎ≤®</button>
    </div>

    <div id="p-dead" class="panel" style="display:none; border-color:#f44336;">
        <h1 style="color:#f44336;">ÏÇ¨Îßù</h1>
        <button class="big-btn" style="background:#f44336;" onclick="Game.restart()">Ïû¨ÏãúÏûë</button>
    </div>
</div>

<script>
/** * ÏïàÏ†ÑÏû•Ïπò: Ïò§Î•ò Î∞úÏÉù Ïãú Í≤ΩÍ≥†Ï∞Ω 
 */
window.onerror = function(msg, url, line) {
    alert("Ïò§Î•ò Î∞úÏÉù: " + msg + "\nÏ§Ñ: " + line + "\nÏÑ∏Ïù¥Î∏å Îç∞Ïù¥ÌÑ∞Î•º Ï¥àÍ∏∞ÌôîÌïòÍ≥† Îã§Ïãú Ïã§ÌñâÌï©ÎãàÎã§.");
    localStorage.removeItem('vq_v2_save');
    location.reload();
    return true;
};

// --- ÏÑ§Ï†ï Î∞è ÏÉÅÏàò ---
const TILE = 40;
const GRAVITY = 0.6;
const BLOCKS = { AIR:0, DIRT:1, GRASS:2, STONE:3, WOOD:4, LEAVES:5, BRICK:6, TNT:12, WATER:20, LAVA:21, GOAL:99, SPIKE:15, ORE_C:9, ORE_G:10, ORE_D:11 };
const ITEMS = { SWORD:100, WAND:101 };

// Î∏îÎ°ù Ï†ïÏùò
const DEFS = {
    [BLOCKS.DIRT]: {c:'#5D4037'}, [BLOCKS.GRASS]: {c:'#5D4037', top:'#4CAF50'},
    [BLOCKS.STONE]: {c:'#757575'}, [BLOCKS.WOOD]: {c:'#5D4037', side:'#3E2723'},
    [BLOCKS.LEAVES]: {c:'#2E7D32'}, [BLOCKS.BRICK]: {c:'#B71C1C'},
    [BLOCKS.TNT]: {c:'#D32F2F', txt:'TNT'}, [BLOCKS.WATER]: {c:'#29B6F6', a:0.5, fluid:true},
    [BLOCKS.LAVA]: {c:'#FF5722', a:0.8, fluid:true}, [BLOCKS.GOAL]: {c:'#6A1B9A'},
    [BLOCKS.ORE_C]: {c:'#757575', dot:'#111', val:5}, [BLOCKS.ORE_G]: {c:'#757575', dot:'#FFD700', val:15},
    [BLOCKS.ORE_D]: {c:'#757575', dot:'#00BCD4', val:50}, [BLOCKS.SPIKE]:{c:'#999', spike:true},
    [ITEMS.SWORD]: {icon:'üó°Ô∏è', c:'#00BCD4', tool:true}, [ITEMS.WAND]: {icon:'üî•', c:'#FF5722', tool:true}
};

// --- Ïò§ÎîîÏò§ (Web Audio API) ---
const Audio = {
    ctx: null,
    init() { if(!this.ctx) this.ctx = new (window.AudioContext||window.webkitAudioContext)(); if(this.ctx.state==='suspended')this.ctx.resume(); },
    play(type, freq, dur, vol=0.1) {
        if(!this.ctx) return;
        let o = this.ctx.createOscillator(), g = this.ctx.createGain();
        o.type = type; o.frequency.setValueAtTime(freq, this.ctx.currentTime);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime+dur);
        o.connect(g); g.connect(this.ctx.destination);
        o.start(); o.stop(this.ctx.currentTime+dur);
    }
};
const SFX = {
    jump: ()=>Audio.play('square', 300, 0.1),
    hit: ()=>Audio.play('sawtooth', 100, 0.1),
    coin: ()=>Audio.play('sine', 1200, 0.15),
    exp: ()=>Audio.play('sawtooth', 50, 0.5)
};

// --- Í≤åÏûÑ ÏóîÏßÑ ---
const Game = {
    cvs: null, ctx: null,
    w: 0, h: 0,
    state: "MENU",
    world: [], mobs: [], parts: [], projs: [], tnts: [],
    ww: 100, wh: 50,
    cam: {x:0, y:0}, shake:0,
    
    // ÌîåÎ†àÏù¥Ïñ¥
    p: {x:0, y:0, w:28, h:38, vx:0, vy:0, hp:100, max:100, gold:0, spd:6, dmg:15, air:100, dir:1, inv:0, wand:false},
    keys: {l:false, r:false, u:false},
    inv: [ITEMS.SWORD, BLOCKS.DIRT, BLOCKS.STONE, BLOCKS.TNT, BLOCKS.WATER],
    slot: 0,
    mode: "MINE",
    lvl: 1,

    init() {
        this.cvs = document.getElementById('cvs');
        this.ctx = this.cvs.getContext('2d', {alpha:false});
        this.resize();
        window.addEventListener('resize', ()=>this.resize());
        
        // ÏûÖÎ†• ÏÑ§Ï†ï
        this.bindBtn('btn-l', 'l'); this.bindBtn('btn-r', 'r'); this.bindBtn('btn-j', 'u');
        document.getElementById('btn-mode').addEventListener('touchstart', (e)=>{
            e.preventDefault();
            this.mode = this.mode==="MINE"?"BUILD":"MINE";
            document.getElementById('btn-mode').innerText = this.mode==="MINE"?"‚õèÔ∏è":"üß±";
        });
        
        // ÌÑ∞Ïπò (Î©îÏù∏ Ïï°ÏÖò)
        this.cvs.addEventListener('touchstart', e=>this.handleTouch(e), {passive:false});
        this.cvs.addEventListener('touchmove', e=>this.handleTouch(e), {passive:false});

        // ÏÑ∏Ïù¥Î∏å ÌôïÏù∏
        if(localStorage.getItem('vq_v2_save')) document.getElementById('btn-load').style.display='inline-block';
        
        // Î£®ÌîÑ ÏãúÏûë
        requestAnimationFrame(()=>this.loop());
    },

    resize() { this.w=this.cvs.width=window.innerWidth; this.h=this.cvs.height=window.innerHeight; },
    
    bindBtn(id, key) {
        let el = document.getElementById(id);
        el.addEventListener('touchstart', e=>{e.preventDefault(); el.style.background='rgba(255,215,0,0.4)'; this.keys[key]=true;});
        el.addEventListener('touchend', e=>{e.preventDefault(); el.style.background=''; this.keys[key]=false;});
    },

    start(reset) {
        Audio.init();
        if(reset) {
            this.lvl=1; 
            this.p = {x:0, y:0, w:28, h:38, vx:0, vy:0, hp:100, max:100, gold:0, spd:6, dmg:15, air:100, dir:1, inv:0, wand:false};
            this.inv = [ITEMS.SWORD, BLOCKS.DIRT, BLOCKS.STONE, BLOCKS.TNT, BLOCKS.WATER];
        }
        this.genLevel(this.lvl);
        this.state = "PLAY";
        document.getElementById('overlay').style.display = 'none';
        this.uiInv();
    },

    load() {
        try {
            let d = JSON.parse(localStorage.getItem('vq_v2_save'));
            if(!d) throw "No Save";
            this.lvl=d.l; this.p=d.p; this.inv=d.i;
            this.start(false);
        } catch(e) {
            alert("ÏÑ∏Ïù¥Î∏å ÌååÏùº Ïò§Î•ò. ÏÉàÎ°ú ÏãúÏûëÌï©ÎãàÎã§.");
            this.start(true);
        }
    },

    genLevel(l) {
        this.world = []; this.mobs = []; this.tnts = []; this.projs = []; this.parts = [];
        this.ww = 100 + l*10;
        
        // ÏßÄÌòï ÏÉùÏÑ±
        let heights = [];
        for(let x=0; x<this.ww; x++) {
            let h = Math.floor(this.wh/2 + Math.sin(x*0.05)*(5+l));
            heights.push(Math.max(5, Math.min(this.wh-5, h)));
        }

        for(let y=0; y<this.wh; y++) {
            let row = [];
            for(let x=0; x<this.ww; x++) {
                let h = heights[x], b = BLOCKS.AIR;
                // ÏïàÏ†ÑÏßÄÎåÄ (0~15)
                if(x < 15) {
                    if(y >= Math.floor(this.wh/2)) b = (y===Math.floor(this.wh/2)) ? BLOCKS.GRASS : BLOCKS.DIRT;
                } else {
                    if(y === h) b = BLOCKS.GRASS;
                    else if(y > h && y < h+5) b = BLOCKS.DIRT;
                    else if(y >= h+5) {
                        b = BLOCKS.STONE;
                        if(Math.random()<0.05) b=BLOCKS.ORE_C;
                        else if(Math.random()<0.02) b=BLOCKS.ORE_G;
                        else if(Math.random()<0.005) b=BLOCKS.ORE_D;
                    }
                }
                if(y === this.wh-1) b = BLOCKS.BRICK;
                if(x === this.ww-3 && y === h-1) b = BLOCKS.GOAL;
                row.push(b);
            }
            this.world.push(row);
        }

        // Î™¨Ïä§ÌÑ∞
        for(let i=0; i<5+l; i++) {
            let mx = 20 + Math.floor(Math.random()*(this.ww-40));
            let my = heights[mx] - 2;
            this.spawnMob(mx*TILE, my*TILE, Math.random()<0.5?'SLIME':'ZOMBIE');
        }
        // Î≥¥Ïä§
        if(l%3===0) this.spawnMob((this.ww-10)*TILE, 0, 'BOSS');

        // ÌîåÎ†àÏù¥Ïñ¥ ÏúÑÏπò ÏïàÏ†ÑÌïòÍ≤å Ïû°Í∏∞
        this.p.x = 5 * TILE;
        let startY = (Math.floor(this.wh/2) - 2) * TILE;
        this.p.y = startY;
        this.p.vx = 0; this.p.vy = 0;
        
        // Ïπ¥Î©îÎùº Ï¥àÍ∏∞Ìôî
        this.cam.x = this.p.x - this.w/2;
        this.cam.y = this.p.y - this.h/2;
        
        this.updHud();
    },

    // --- Î©îÏù∏ Î£®ÌîÑ ---
    loop() {
        if(this.state === "PLAY") this.update();
        this.draw();
        requestAnimationFrame(()=>this.loop());
    },

    update() {
        if(this.shake > 0) this.shake *= 0.9;
        if(this.p.inv > 0) this.p.inv--;

        // Î¨ºÎ¶¨ - ÌîåÎ†àÏù¥Ïñ¥
        let bx = Math.floor((this.p.x+14)/TILE), by = Math.floor((this.p.y+19)/TILE);
        let b = this.getB(bx, by), fluid = (b===BLOCKS.WATER || b===BLOCKS.LAVA);
        
        let spd = this.p.spd * (fluid ? 0.5 : 1);
        if(this.keys.l) { this.p.vx = -spd; this.p.dir = -1; }
        else if(this.keys.r) { this.p.vx = spd; this.p.dir = 1; }
        else this.p.vx = 0;

        if(this.keys.u) {
            if(fluid) { this.p.vy = -3; SFX.jump(); }
            else if(this.p.grounded) { this.p.vy = -11; this.p.grounded=false; SFX.jump(); }
            this.keys.u = false;
        }

        if(fluid) {
            this.p.vy += 0.1; if(this.p.vy > 3) this.p.vy=3;
            this.p.air -= 0.5;
            if(this.p.air<=0) this.hitP(1);
        } else {
            this.p.vy += GRAVITY;
            this.p.air = Math.min(100, this.p.air+1);
        }
        if(b===BLOCKS.LAVA) this.hitP(1);

        this.p.x += this.p.vx; this.col(this.p, 'x');
        this.p.y += this.p.vy; this.p.grounded=false; this.col(this.p, 'y');

        if(this.p.y > this.wh*TILE + 200 || this.p.hp <= 0) this.die();

        // Î™©Ìëú ÌôïÏù∏
        if(this.getB(Math.floor((this.p.x+14)/TILE), Math.floor((this.p.y+19)/TILE)) === BLOCKS.GOAL) {
            this.win();
        }

        // Ïπ¥Î©îÎùº Ï∂îÏ†Å
        this.cam.x += (this.p.x + 14 - this.w/2 - this.cam.x) * 0.1;
        this.cam.y += (this.p.y + 19 - this.h/2 - this.cam.y) * 0.1;

        // ÏóîÌã∞Ìã∞ ÏóÖÎç∞Ïù¥Ìä∏
        this.mobs.forEach((m,i)=>{
            if(Math.abs(this.p.x - m.x) < 500) {
                m.vx = (this.p.x > m.x ? 1 : -1) * m.spd;
                m.vy += GRAVITY;
                if(this.isBlocked(m) && m.grounded) m.vy = -10;
                
                m.x += m.vx; this.col(m, 'x');
                m.y += m.vy; m.grounded=false; this.col(m, 'y');

                if(this.rectCol(this.p, m)) {
                    this.hitP(10);
                    this.p.vx = Math.sign(this.p.x - m.x) * 10; this.p.vy = -5;
                }
            }
            if(m.hurt>0) m.hurt--;
            if(m.hp <= 0) {
                this.p.gold += m.rew; SFX.coin(); this.showToast(`+${m.rew}G`);
                this.spawnPart(m.x, m.y, m.c, 10);
                this.mobs.splice(i,1); this.updHud();
                if(m.boss) document.getElementById('boss-hud').style.display='none';
            }
        });

        // TNT
        this.tnts.forEach((t,i)=>{
            t.t--; if(t.t<=0) { this.explode(t.x, t.y, 4); this.tnts.splice(i,1); }
        });

        // Î∞úÏÇ¨Ï≤¥
        this.projs.forEach((p,i)=>{
            p.x += p.vx; p.y += p.vy; p.vy += 0.2; p.life--;
            let tx = Math.floor(p.x/TILE), ty = Math.floor(p.y/TILE);
            if(this.getB(tx,ty)!==BLOCKS.AIR || p.life<=0) {
                this.explode(tx, ty, 2); this.projs.splice(i,1);
            } else {
                // Î™π Ï∂©Îèå
                for(let m of this.mobs) {
                    if(this.rectCol({x:p.x, y:p.y, w:5, h:5}, m)) {
                        m.hp -= (30 + this.p.dmg); m.hurt=10;
                        this.explode(tx, ty, 1); this.projs.splice(i,1); break;
                    }
                }
            }
        });

        // ÌååÌã∞ÌÅ¥
        this.parts.forEach((p,i)=>{
            p.x+=p.vx; p.y+=p.vy; p.vy+=0.5; p.life--;
            if(p.life<=0) this.parts.splice(i,1);
        });
    },

    // --- Î¨ºÎ¶¨ Î∞è Ï∂©Îèå ---
    getB(x, y) {
        if(x<0 || x>=this.ww || y<0 || y>=this.wh) return BLOCKS.AIR;
        return this.world[y][x];
    },
    col(e, axis) {
        let l = Math.floor(e.x/TILE), r = Math.floor((e.x+e.w-0.01)/TILE);
        let t = Math.floor(e.y/TILE), b = Math.floor((e.y+e.h-0.01)/TILE);
        
        for(let y=t; y<=b; y++) for(let x=l; x<=r; x++) {
            let id = this.getB(x, y);
            let def = DEFS[id];
            if(id===BLOCKS.AIR || (def && def.fluid)) continue;
            
            if(axis === 'x') {
                if(e.vx > 0) e.x = x*TILE - e.w;
                else e.x = (x+1)*TILE;
                e.vx = 0;
            } else {
                if(e.vy > 0) { e.y = y*TILE - e.h; e.grounded = true; }
                else e.y = (y+1)*TILE;
                e.vy = 0;
            }
            return;
        }
    },
    isBlocked(e) {
        let tx = Math.floor((e.x + (e.vx>0?e.w+5:-5))/TILE);
        let ty = Math.floor((e.y+e.h-5)/TILE);
        let b = this.getB(tx, ty);
        return b!==BLOCKS.AIR && !DEFS[b]?.fluid;
    },
    rectCol(a, b) { return a.x < b.x+b.w && a.x+a.w > b.x && a.y < b.y+b.h && a.y+a.h > b.y; },

    // --- Ïï°ÏÖò ---
    handleTouch(e) {
        if(this.state !== "PLAY") return;
        e.preventDefault();
        let t = e.touches[0];
        let rect = this.cvs.getBoundingClientRect();
        let mx = t.clientX - rect.left + this.cam.x;
        let my = t.clientY - rect.top + this.cam.y;
        
        // ÏïÑÏù¥ÌÖú ÏÇ¨Ïö©
        let item = this.inv[this.slot];
        let idef = DEFS[item];
        
        if(idef && idef.tool) {
            if(this.p.inv > 0) return;
            this.p.inv = 15;
            if(item === ITEMS.SWORD) {
                // Í∑ºÏ†ë Í≥µÍ≤©
                let hitBox = {x: this.p.x + (this.p.dir===1?0:-60), y:this.p.y, w:80, h:50};
                this.mobs.forEach(m=>{
                    if(this.rectCol(hitBox, m)) {
                        m.hp -= this.p.dmg; m.hurt=10; m.vy=-5;
                        this.spawnPart(m.x, m.y, '#fff', 5); SFX.hit();
                    }
                });
            } else {
                // ÏôÑÎìú
                let ang = Math.atan2(my-(this.p.y+20), mx-(this.p.x+14));
                this.projs.push({x:this.p.x+14, y:this.p.y+20, vx:Math.cos(ang)*10, vy:Math.sin(ang)*10, life:50});
                SFX.hit();
            }
            return;
        }

        // Î∏îÎ°ù ÏÉÅÌò∏ÏûëÏö©
        let tx = Math.floor(mx/TILE), ty = Math.floor(my/TILE);
        let dist = Math.hypot((this.p.x+14)-mx, (this.p.y+19)-my);
        if(dist > 200) return;

        if(this.mode === "MINE") {
            let b = this.getB(tx, ty);
            if(b === BLOCKS.TNT) { this.world[ty][tx]=BLOCKS.AIR; this.tnts.push({x:tx, y:ty, t:100}); }
            else if(b!==BLOCKS.AIR && b!==BLOCKS.GOAL) {
                let def = DEFS[b];
                if(this.p.gold >= 1) {
                    this.p.gold--;
                    if(def.val) { this.p.gold += def.val; this.showToast(`+${def.val}G`); SFX.coin(); }
                    this.spawnPart(tx*TILE, ty*TILE, def.c, 5);
                    this.world[ty][tx] = BLOCKS.AIR;
                    this.updHud();
                } else this.showToast("Í≥®Îìú Î∂ÄÏ°±!");
            }
        } else {
            // BUILD
            if(this.getB(tx, ty) === BLOCKS.AIR) {
                let cost = (item===BLOCKS.WATER?5:1);
                if(this.p.gold >= cost) {
                    this.p.gold -= cost;
                    this.world[ty][tx] = item;
                    this.updHud();
                } else this.showToast("Í≥®Îìú Î∂ÄÏ°±!");
            }
        }
    },

    hitP(dmg) {
        if(this.p.inv>0) return;
        this.p.hp -= dmg; this.p.inv=30; this.shake=5; SFX.hit(); this.updHud();
    },

    explode(cx, cy, r) {
        SFX.exp(); this.shake=10; this.spawnPart(cx*TILE, cy*TILE, '#F00', 20);
        let rad = Math.ceil(r);
        for(let y=cy-rad; y<=cy+rad; y++) for(let x=cx-rad; x<=cx+rad; x++) {
            if((x-cx)**2 + (y-cy)**2 <= r**2) {
                if(this.getB(x,y)!==BLOCKS.GOAL) if(this.world[y]) this.world[y][x]=BLOCKS.AIR;
            }
        }
        this.mobs.forEach(m=>{
            if(Math.hypot(m.x/TILE-cx, m.y/TILE-cy) < r) { m.hp-=50; m.hurt=10; }
        });
    },

    die() {
        this.state = "DEAD";
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('p-dead').style.display = 'block';
    },

    win() {
        this.state = "SHOP";
        this.p.gold += 100;
        localStorage.setItem('vq_v2_save', JSON.stringify({l:this.lvl, p:this.p, i:this.inv}));
        document.getElementById('overlay').style.display = 'flex';
        document.getElementById('p-shop').style.display = 'block';
        this.showToast("Ï†ÄÏû•Îê®");
    },
    
    restart() { this.p.hp=this.p.max; this.start(false); },
    nextLevel() { this.lvl++; this.start(false); },

    // --- Ïú†Ìã∏ ---
    spawnMob(x, y, type) {
        const stats = {
            'SLIME': {w:30, h:20, hp:30, spd:2, rew:10, c:'#76ff03'},
            'ZOMBIE': {w:28, h:38, hp:50, spd:1.5, rew:20, c:'#2e7d32'},
            'BOSS': {w:80, h:80, hp:500, spd:3, rew:500, c:'#E91E63', boss:true}
        };
        let s = stats[type];
        this.mobs.push({x, y, vx:0, vy:0, w:s.w, h:s.h, hp:s.hp+this.lvl*10, max:s.hp+this.lvl*10, spd:s.spd, rew:s.rew, c:s.c, boss:s.boss, hurt:0, grounded:false});
    },
    spawnPart(x, y, c, n) {
        for(let i=0; i<n; i++) this.parts.push({x:x+20, y:y+20, vx:(Math.random()-.5)*10, vy:(Math.random()-.5)*10, c, life:30, s:Math.random()*5+2});
    },
    buy(t) {
        let cost=0;
        if(t==='heal'){cost=50; if(this.p.gold>=cost) this.p.hp=Math.min(this.p.hp+50, this.p.max);}
        if(t==='dmg'){cost=200; if(this.p.gold>=cost) this.p.dmg+=10;}
        if(t==='spd'){cost=150; if(this.p.gold>=cost) this.p.spd++;}
        if(t==='hp'){cost=300; if(this.p.gold>=cost) {this.p.max+=50; this.p.hp+=50;}}
        if(t==='wand'){cost=500; if(this.p.gold>=cost && !this.p.wand) {this.p.wand=true; this.inv.push(ITEMS.WAND); this.uiInv();}}
        if(this.p.gold>=cost) { this.p.gold-=cost; SFX.coin(); this.updHud(); } else this.showToast("Í≥®Îìú Î∂ÄÏ°±!");
    },
    
    // UI ÏóÖÎç∞Ïù¥Ìä∏
    updHud() {
        document.getElementById('ui-lv').innerText = this.lvl;
        document.getElementById('ui-gold').innerText = Math.floor(this.p.gold);
        document.getElementById('hp-bar').style.width = Math.max(0, this.p.hp/this.p.max*100)+'%';
        let airDiv = document.getElementById('air-con');
        if(this.p.air < 100) { airDiv.style.display='block'; document.getElementById('air-bar').style.width=this.p.air+'%'; }
        else airDiv.style.display='none';
        
        let boss = this.mobs.find(m=>m.boss);
        let bHud = document.getElementById('boss-hud');
        if(boss && Math.abs(this.p.x - boss.x) < 600) {
            bHud.style.display = 'block';
            document.getElementById('boss-fill').style.width = (boss.hp/boss.max*100)+'%';
        } else bHud.style.display = 'none';
    },
    uiInv() {
        let d = document.getElementById('inv-wrap'); d.innerHTML = '';
        this.inv.forEach((id, i)=>{
            let el = document.createElement('div');
            el.className = 'slot' + (i===this.slot?' active':'');
            let def = DEFS[id];
            if(def.tool) el.innerHTML = `<span class="icon">${def.icon}</span>`;
            else el.innerHTML = `<div class="b-preview" style="background:${def.c}; ${def.top?`border-top:3px solid ${def.top}`:''}"></div>`;
            el.onclick = ()=>{ this.slot=i; this.uiInv(); };
            d.appendChild(el);
        });
    },
    showToast(msg) {
        let el = document.getElementById('toast');
        el.innerText = msg; el.style.opacity=1;
        setTimeout(()=>el.style.opacity=0, 1500);
    },

    // --- Í∑∏Î¶¨Í∏∞ ---
    draw() {
        // Î∞∞Í≤Ω
        this.ctx.fillStyle = '#87CEEB';
        this.ctx.fillRect(0, 0, this.w, this.h);
        
        this.ctx.save();
        // Ïπ¥Î©îÎùº (Ï†ïÏàòÌôîÎ°ú Îñ®Î¶º Î∞©ÏßÄ)
        let cx = Math.floor(this.cam.x), cy = Math.floor(this.cam.y);
        this.ctx.translate(-cx + (Math.random()-.5)*this.shake, -cy + (Math.random()-.5)*this.shake);
        
        // Î∏îÎ°ù Î†åÎçîÎßÅ Î≤îÏúÑ (ÏµúÏ†ÅÌôî)
        let sc = Math.floor(cx/TILE), ec = sc + Math.ceil(this.w/TILE) + 1;
        let sr = Math.floor(cy/TILE), er = sr + Math.ceil(this.h/TILE) + 1;

        for(let y=Math.max(0, sr); y<Math.min(this.wh, er); y++) {
            if(!this.world[y]) continue; 
            for(let x=Math.max(0, sc); x<Math.min(this.ww, ec); x++) {
                let b = this.world[y][x];
                if(b !== BLOCKS.AIR) {
                    let d = DEFS[b];
                    let px = x*TILE, py = y*TILE;
                    if(d.a) this.ctx.globalAlpha = d.a;
                    this.ctx.fillStyle = d.c;
                    
                    if(b===BLOCKS.WATER && (!this.world[y-1] || this.world[y-1][x]===BLOCKS.AIR)) {
                         this.ctx.fillRect(px, py+5, TILE, TILE-5);
                         this.ctx.fillStyle = 'rgba(255,255,255,0.4)'; this.ctx.fillRect(px, py+5, TILE, 3);
                    } else if(d.spike) {
                         this.ctx.beginPath(); this.ctx.moveTo(px, py+TILE); this.ctx.lineTo(px+TILE/2, py); this.ctx.lineTo(px+TILE, py+TILE); this.ctx.fill();
                    } else {
                        this.ctx.fillRect(px, py, TILE, TILE);
                        if(d.top) { this.ctx.fillStyle=d.top; this.ctx.fillRect(px, py, TILE, 8); }
                        if(d.dot) { this.ctx.fillStyle=d.dot; this.ctx.fillRect(px+10, py+10, 10, 10); }
                        if(d.txt) { this.ctx.fillStyle='white'; this.ctx.font='10px arial'; this.ctx.fillText(d.txt, px+8, py+24); }
                    }
                    this.ctx.globalAlpha = 1.0;
                }
            }
        }
        
        // Î†åÎçîÎßÅ: TNT
        this.tnts.forEach(t=>{
            this.ctx.fillStyle = (Math.floor(Date.now()/100)%2===0) ? 'white' : '#D32F2F';
            this.ctx.fillRect(t.x*TILE, t.y*TILE, TILE, TILE);
        });

        // Î†åÎçîÎßÅ: Î™¨Ïä§ÌÑ∞
        this.mobs.forEach(m=>{
            this.ctx.fillStyle = m.hurt>0?'white':m.c;
            this.ctx.fillRect(m.x, m.y, m.w, m.h);
            // Ï≤¥Î†•Î∞î
            this.ctx.fillStyle = '#333'; this.ctx.fillRect(m.x, m.y-8, m.w, 4);
            this.ctx.fillStyle = '#0f0'; this.ctx.fillRect(m.x, m.y-8, m.w*(m.hp/m.max), 4);
        });

        // Î†åÎçîÎßÅ: ÌîåÎ†àÏù¥Ïñ¥
        this.ctx.fillStyle = '#FFC107'; this.ctx.fillRect(this.p.x, this.p.y, this.p.w, this.p.h);
        this.ctx.fillStyle = '#1976D2'; this.ctx.fillRect(this.p.x, this.p.y+20, this.p.w, 18);
        this.ctx.fillStyle = 'black';
        let off = this.p.dir===1 ? 4 : -4;
        this.ctx.fillRect(this.p.x+14+off-6, this.p.y+8, 4, 4); this.ctx.fillRect(this.p.x+14+off+2, this.p.y+8, 4, 4);
        
        // ÎèÑÍµ¨
        let item = this.inv[this.slot];
        let idef = DEFS[item];
        if(idef.tool) {
            this.ctx.save(); this.ctx.translate(this.p.x+14, this.p.y+20);
            if(this.p.dir===-1) this.ctx.scale(-1, 1);
            if(this.p.inv > 5) this.ctx.rotate(-1);
            this.ctx.fillStyle = idef.c; this.ctx.fillRect(10, -4, 24, 6);
            this.ctx.restore();
        }

        // ÌååÌã∞ÌÅ¥
        this.parts.forEach(p=>{
            this.ctx.fillStyle = p.c; this.ctx.fillRect(p.x, p.y, p.s, p.s);
        });

        this.ctx.restore();
    }
};

window.onload = ()=>Game.init();

</script>
</body>
</html>
